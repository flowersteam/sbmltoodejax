
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Gradient descent &#8212; sbmltoodejax</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=0f4711b3"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/gradient_descent';</script>
    <link rel="canonical" href="https://developmentalsystems.org/sbmltoodejax/tutorials/gradient_descent.html" />
    <link rel="icon" href="../_static/logo.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="sbmltoodejax.parse" href="../api/parse.html" />
    <link rel="prev" title="Benchmarking" href="benchmark.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.4.3" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="sbmltoodejax - Home"/>
    <img src="../_static/logo.svg" class="logo__image only-dark pst-js-only" alt="sbmltoodejax - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">SBMLtoODEjax</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../index.html">üè° Home</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">üõ†Ô∏è Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../why_use.html">üëÄ Why SBMLtoODEjax?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_principles.html">üé® Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">ü§ù Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jax101.html">üìé Jax 101 [external]</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">üéì Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="biomodels_curation.html">Numerical simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel_execution.html">Parallel execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmarking</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Gradient descent</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Public API - sbmltoodejax package</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../api/parse.html"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.parse</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/modulegeneration.html"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.modulegeneration</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/jaxfuncs.html"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.jaxfuncs</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/biomodels_api.html"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.biomodels_api</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/utils.html"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.utils</span></code></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/flowersteam/sbmltoodejax/blob/main/docs/tutorials/gradient_descent.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/flowersteam/sbmltoodejax" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tutorials/gradient_descent.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Gradient descent</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-utils">Imports and Utils</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-definition">Problem definition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-of-behavior-by-tuning-of-kinematic-parameters-c">Optimization of behavior by tuning of kinematic parameters <em>c</em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-of-behavior-by-dynamical-intervention-on-y-states">Optimization of behavior by dynamical intervention on <em>y</em> states</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">‚ö†Ô∏è Limitations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="gradient-descent">
<h1>Gradient descent<a class="headerlink" href="#gradient-descent" title="Link to this heading">#</a></h1>
<p>In this tutorial, we will see how SBMLtoODEjax integrates seamlessly with <a class="reference external" href="https://optax.readthedocs.io/en/latest/">Optax</a> pipeline, a gradient processing and optimization library for JAX.
Whereas Optax has typically been used to optimize parameters of neural networks, we will see that it can be used in the very same way to optimize parameters of our SBMLtoODEjax models.</p>
<p>More precisely, users can define their own loss function over the model outputs <span class="math notranslate nohighlight">\((ys,ws)\)</span> and their own optax optimizer and learning rate scheduler to optimize model parameters toward a target behavior. Interestingly, optimization can be done with respect to any desired parameters including: model parameters (constant kinematic parameters <span class="math notranslate nohighlight">\(c\)</span>) and/or initial states (node states <span class="math notranslate nohighlight">\(y_0\)</span> or model parameters <span class="math notranslate nohighlight">\(w_0\)</span>), but also parameters of more advanced intervention strategies e.g. dynamical interventions on the network states <span class="math notranslate nohighlight">\(y=[y(t=0), \dots, y(t=T)]\)</span>, or why not even with respect to model hyperparameters (e.g. odeint solver atol or rtol parameters).</p>
<section id="imports-and-utils">
<h2>Imports and Utils<a class="headerlink" href="#imports-and-utils" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_platform_name&quot;</span><span class="p">,</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">equinox</span> <span class="k">as</span> <span class="nn">eqx</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">lax</span><span class="p">,</span> <span class="n">value_and_grad</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">from</span> <span class="nn">sbmltoodejax.utils</span> <span class="kn">import</span> <span class="n">load_biomodel</span>


<span class="c1"># utils</span>
<span class="k">def</span> <span class="nf">sine_wave</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="o">+</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">default_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">204</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">167</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">178</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">230</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>  
                  <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mi">115</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">127</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">127</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">240</span><span class="p">,</span><span class="mi">228</span><span class="p">,</span><span class="mi">66</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">148</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">189</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">86</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">233</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">213</span><span class="p">,</span><span class="mi">94</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mi">75</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">214</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">40</span><span class="p">),</span>
                  <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
<span class="n">default_colors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">c</span><span class="o">/</span><span class="mi">255</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color</span><span class="p">])</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">default_colors</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="problem-definition">
<h2>Problem definition<a class="headerlink" href="#problem-definition" title="Link to this heading">#</a></h2>
<p>In this tutorial we will focus on the <a class="reference external" href="https://www.ebi.ac.uk/biomodels/BIOMD0000000145">biomodel #145</a> which models ATP-induced intracellular calcium oscillations.
We will assume an (arbitrary) target sine-wave behavior that we wish the cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration (<code class="docutils literal notranslate"><span class="pre">Ca_Cyt</span></code>) to follow.</p>
<p>Below, we show the obtained time-course evolution of the different components (including <code class="docutils literal notranslate"><span class="pre">Ca_Cyt</span></code> in gray) given the provided initial conditions <span class="math notranslate nohighlight">\((y_0, w_0)\)</span> and kinematic parameters <span class="math notranslate nohighlight">\(c\)</span>, and plot the target sine-wave (dashed gray curve).</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load model</span>
<span class="n">model_idx</span> <span class="o">=</span> <span class="mi">145</span>
<span class="n">model</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">load_biomodel</span><span class="p">(</span><span class="n">model_idx</span><span class="p">)</span>

<span class="c1"># Run simulation</span>
<span class="n">deltaT</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">n_secs</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_secs</span><span class="o">/</span><span class="n">deltaT</span><span class="p">)</span>
<span class="n">default_ys</span><span class="p">,</span> <span class="n">default_ws</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="c1"># plot results</span>
<span class="n">y_indexes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">modelstepfunc</span><span class="o">.</span><span class="n">y_indexes</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">y_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">default_ys</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>

<span class="c1"># plot target sine wave</span>
<span class="n">target_Ca_Cyt</span> <span class="o">=</span> <span class="n">sine_wave</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">target_Ca_Cyt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;target_Ca_Cyt&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Ca_Cyt&quot;</span><span class="p">]])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration (nM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Simulation with default (y0, w0, c)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/315a2394bd065d8b591b39180d54c983f96da236754aade93f75346d0dbfb6f7.png" src="../_images/315a2394bd065d8b591b39180d54c983f96da236754aade93f75346d0dbfb6f7.png" />
</div>
</div>
<p>We can see that the cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration (gray curve) already follows some oscillatory pattern, but with different signal shape and mean/amplitude/frequency than the target sine wave (dashed gray curve).</p>
<p><strong>Question: Can we modify model parameters for it to exhibit target oscillatory pattern for the cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration ?</strong></p>
<p>In first part of this tutorial, we will see how to do <a class="reference internal" href="#optimization-by-tuning-c"><span class="std std-ref">optimization of behavior by tuning of kinematic parameters <em>c</em></span></a>, which corresponds to changing network connection weights (and could be equivalent of targeting promoter sequences or protein structures). Then, we will see how to do stimuli-based <a class="reference internal" href="#optimization-by-intervention-on-y"><span class="std std-ref">optimization of behavior by dynamical intervention on <em>y</em> states</span></a>, where control here is achieved by temporally regulated patterns of stimuli on specific nodes (instead of rewiring of the network structure or weights). Whereas slightly more difficult to define, optimization via temporally regulated patterns of stimuli is interesting from a biomedical perspective.</p>
</section>
<section id="optimization-of-behavior-by-tuning-of-kinematic-parameters-c">
<span id="optimization-by-tuning-c"></span><h2>Optimization of behavior by tuning of kinematic parameters <em>c</em><a class="headerlink" href="#optimization-of-behavior-by-tuning-of-kinematic-parameters-c" title="Link to this heading">#</a></h2>
<p>Let‚Äôs start by optimizing kinematic parameters <span class="math notranslate nohighlight">\(c\)</span> toward the desired sine wave pattern <code class="docutils literal notranslate"><span class="pre">target_Ca_Cyt</span></code>.
As we can see below, we can integrate SBMLtoODEjax models with Optax pipeline by (i) defining loss function (with respect to parameters <span class="math notranslate nohighlight">\(c\)</span>) that runs the SBMLtoODEjax model simulation,
(ii) defining the update step function (which computes derivatives of the loss function and then updates <span class="math notranslate nohighlight">\(c\)</span> accordingly), and (iii) running the typical optimization loop, here with <code class="docutils literal notranslate"><span class="pre">optax.adam</span></code> optimizer and no learning rate scheduler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load Model</span>
<span class="n">model</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">load_biomodel</span><span class="p">(</span><span class="n">model_idx</span><span class="p">)</span>

<span class="c1"># Optax pipeline</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;loss function&quot;&quot;&quot;</span>
    <span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Ca_Cyt&quot;</span><span class="p">]]</span>
                               <span class="o">-</span><span class="n">target_Ca_Cyt</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">make_step</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;update function&quot;&quot;&quot;</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">value_and_grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">)(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">opt_state</span>

<span class="n">n_optim_steps</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">optim_step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_optim_steps</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">make_step</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
    <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot train loss</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;optim steps&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Training loss&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot simulation results with optimized c</span>
<span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">y_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">target_Ca_Cyt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;target_Ca_Cyt&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Ca_Cyt&quot;</span><span class="p">]])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration (nM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Simulation with default (y0, w0) and optimized c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f1521a61aeca435ef6700b45c2b8f9ceeb2ca0fd1bbef7546f81a99b8b1796dd.png" src="../_images/f1521a61aeca435ef6700b45c2b8f9ceeb2ca0fd1bbef7546f81a99b8b1796dd.png" />
<img alt="../_images/5cca6eeffd4e2b3dc18b6196e54f9fa62749e6a0b2620e91b4afb99e02891b50.png" src="../_images/5cca6eeffd4e2b3dc18b6196e54f9fa62749e6a0b2620e91b4afb99e02891b50.png" />
</div>
</div>
<p>We can see that here, the optimization successfully learned to modify kinematic parameters <span class="math notranslate nohighlight">\(c\)</span> to minimize training loss (from <span class="math notranslate nohighlight">\(\sim 8400\)</span> to <span class="math notranslate nohighlight">\(\sim 500\)</span>).
When running simulation with the optimized parameters <span class="math notranslate nohighlight">\(c\)</span>, we can see that the cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration follows an oscillatory pattern close to target one with similar mean and frequency, but does not match perfectly the target pattern, either because it is simply not feasible given the network structure and initial conditions or because optimization is stuck in a local minima.</p>
<p>Below, we run the same simulation for longer reaction time (100 secs). We can see that the tuning of <span class="math notranslate nohighlight">\(c\)</span> led to long-lasting changes, as the cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration keeps the same oscillatory behavior even after time seen during training (50 secs). This is expected as we modified the network connection weights.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># longer rollout</span>
<span class="n">long_ys</span><span class="p">,</span> <span class="n">long_ws</span><span class="p">,</span> <span class="n">long_ts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">y_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">long_ts</span><span class="p">,</span> <span class="n">long_ys</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration (nM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Longer simulation with optimized c&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1047162a63314a00a6f4b18ff7783ea6bedf9ecdd4ddbf6362d063176aabdd1e.png" src="../_images/1047162a63314a00a6f4b18ff7783ea6bedf9ecdd4ddbf6362d063176aabdd1e.png" />
</div>
</div>
</section>
<section id="optimization-of-behavior-by-dynamical-intervention-on-y-states">
<span id="optimization-by-intervention-on-y"></span><h2>Optimization of behavior by dynamical intervention on <em>y</em> states<a class="headerlink" href="#optimization-of-behavior-by-dynamical-intervention-on-y-states" title="Link to this heading">#</a></h2>
<p>In this section, we will see how to perform more advanced interventions on the node dynamical states <span class="math notranslate nohighlight">\(y\)</span>.
To do so, let‚Äôs first define a wrapper on the model rollout module that allows, during the model rollout, to apply interventions that set some node states to controlled values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ModelRolloutWithIntervention</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">deltaT</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">static_field</span><span class="p">()</span>
    <span class="n">modelstep_fn</span><span class="p">:</span> <span class="n">eqx</span><span class="o">.</span><span class="n">Module</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltaT</span><span class="p">,</span> <span class="n">modelstep_fn</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deltaT</span> <span class="o">=</span> <span class="n">deltaT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelstep_fn</span> <span class="o">=</span> <span class="n">modelstep_fn</span>

    <span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;n_steps&quot;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

        <span class="nd">@jit</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">carry</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modelstep_fn</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaT</span><span class="p">)</span>
            
            <span class="c1"># Add intervention</span>
            <span class="n">interval_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_to_interval</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">((</span><span class="n">interval_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_intervention</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_null</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">interval_idx</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">t0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_steps</span><span class="p">))</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ts</span>

    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">time_to_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns -1 if t not in intervention_ts, else return corresponding interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">intervention_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">deltaT</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">apply_intervention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">interval_idx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">intervention_ys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">y_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">[</span><span class="n">y_idx</span><span class="p">][</span><span class="n">interval_idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">y</span>
    
    <span class="nd">@jit</span>
    <span class="k">def</span> <span class="nf">apply_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">interval_idx</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y</span>
    
<span class="n">model</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">load_biomodel</span><span class="p">(</span><span class="n">model_idx</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ModelRolloutWithIntervention</span><span class="p">(</span><span class="n">deltaT</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">modelstepfunc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can then define the loss function and optimizer update step as before, but this time the loss function is defined with respect to intervention parameters <code class="docutils literal notranslate"><span class="pre">intervention_ys</span></code> .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="n">ys</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Ca_Cyt&quot;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">target_Ca_Cyt</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">loss</span>


<span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_jit</span>
<span class="k">def</span> <span class="nf">make_step</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">value_and_grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">)(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
    <span class="n">intervention_ys</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">opt_state</span>
</pre></div>
</div>
</div>
</div>
<p>Here, the intervention parameters <code class="docutils literal notranslate"><span class="pre">intervention_ys</span></code> is 2x500 and is used to set the values of nodes <code class="docutils literal notranslate"><span class="pre">Galpha_GTP</span></code> and <code class="docutils literal notranslate"><span class="pre">IP3</span></code> during 500 first time steps (50 secs), in a free manner.</p>
<p>We try two different initializations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">intervention_ys_init_1</span></code> which is the default values of nodes <code class="docutils literal notranslate"><span class="pre">Galpha_GTP</span></code> and <code class="docutils literal notranslate"><span class="pre">IP3</span></code> (as obtained when simulating with default parameters <span class="math notranslate nohighlight">\(c\)</span> and initial conditions <span class="math notranslate nohighlight">\(y_0, w_0\)</span>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">intervention_ys_init_2</span></code> which makes <code class="docutils literal notranslate"><span class="pre">Galpha_GTP</span></code> and <code class="docutils literal notranslate"><span class="pre">IP3</span></code> initially follow a predefined sine wave pattern (but the optimizer can then modify the parameters in a free manner)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention_ts</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

<span class="n">intervention_ys_init_1</span> <span class="o">=</span> <span class="p">{</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Galpha_GTP&quot;</span><span class="p">]:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">default_ys</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Galpha_GTP&quot;</span><span class="p">]]),</span> 
                          <span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;IP3&quot;</span><span class="p">]:</span>  <span class="n">deepcopy</span><span class="p">(</span><span class="n">default_ys</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;IP3&quot;</span><span class="p">]])}</span>
<span class="n">ys_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys_init_1</span><span class="p">)</span>

<span class="n">intervention_ys_init_2</span> <span class="o">=</span> <span class="p">{</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Galpha_GTP&quot;</span><span class="p">]:</span> <span class="n">sine_wave</span><span class="p">(</span><span class="n">intervention_ts</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span>
                          <span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;IP3&quot;</span><span class="p">]:</span> <span class="n">sine_wave</span><span class="p">(</span><span class="n">intervention_ts</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">5</span><span class="p">)}</span>
<span class="n">ys_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys_init_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs now run the optimization with standard Optax pipeline as before, starting from the two proposed initializations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optim from init 1</span>
<span class="n">n_optim_steps</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span>

<span class="n">intervention_ys</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">intervention_ys_init_1</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">)</span>
<span class="n">train_loss_1</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">optim_step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_optim_steps</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">make_step</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
    <span class="n">train_loss_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    
<span class="n">optimized_ys_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optim from init 2</span>
<span class="n">n_optim_steps</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">)</span>

<span class="n">intervention_ys</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">intervention_ys_init_2</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">)</span>
<span class="n">train_loss_2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">optim_step_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_optim_steps</span><span class="p">):</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">make_step</span><span class="p">(</span><span class="n">intervention_ys</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
    <span class="n">train_loss_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    
<span class="n">optimized_ys_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">13</span><span class="p">))</span>

<span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">y_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys_1</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">optimized_ys_1</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys_2</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">optimized_ys_2</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">target_Ca_Cyt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;target_Ca_Cyt&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_indexes</span><span class="p">[</span><span class="s2">&quot;Ca_Cyt&quot;</span><span class="p">]])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time (secs)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration (nM)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_loss_1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Initial intervention (default y[Galpha_GTP] and y[IP3])&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Optimized intervention&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;train loss&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Initial intervention (sine waves y[Galpha_GTP] and y[IP3])&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Optimized intervention&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;train loss&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Optimization by intervention on Galpha_GTP and IP3 dynamical states&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.93</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/86cdc6ca4bafcace1e55713ae4a572859258fcb33bfa263b7b265d806fc53002.png" src="../_images/86cdc6ca4bafcace1e55713ae4a572859258fcb33bfa263b7b265d806fc53002.png" />
</div>
</div>
<p>We can see that once again, for both tested initializations, the optimization successfully learned to modify the intervention values on nodes <code class="docutils literal notranslate"><span class="pre">Galpha_GTP</span></code> and <code class="docutils literal notranslate"><span class="pre">IP3</span></code> to minimize the training loss.
However, one again the optimization is not perfect and more importantly the choice of initialization seems to have a big impact on the final behavior, suggesting that there are several local minimas that optimization can get stuck into. For instance here we can see that the second optimization led to some clean oscillatory cytoplasmic <span class="math notranslate nohighlight">\(Ca^{2+}\)</span> concentration (similar to what we obtained when tuning <span class="math notranslate nohighlight">\(c\)</span>) whereas the first optimization led to more chaotic oscillatory pattern.</p>
<p>However, when we run the simulation for longer reaction time (100 secs), we can see that contrary to the long-lasting changes obtained by tuning <span class="math notranslate nohighlight">\(c\)</span> here the signal converges back to some relaxed oscillatory pattern as soon as we stop sending the regulated pattern stimuli. This does not mean that perturbation via pulsed stimuli cannot induce long-lasting changes, but that it might require more advanced search and optimization strategies.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># longer rollout</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">long_optimized_ys_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">n_steps</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">intervention_ts</span><span class="p">,</span> <span class="n">intervention_ys</span><span class="p">)</span>
<span class="k">for</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">y_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">long_ts</span><span class="p">,</span> <span class="n">long_optimized_ys_2</span><span class="p">[</span><span class="n">y_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="n">y_idx</span><span class="p">])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Reaction time (secs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Concentration (nM)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/586be993efd26d6f0f6cf713bb9b2c2c10e92d1195c51cde6bb6b2abdc6709c7.png" src="../_images/586be993efd26d6f0f6cf713bb9b2c2c10e92d1195c51cde6bb6b2abdc6709c7.png" />
</div>
</div>
</section>
<section id="limitations">
<h2>‚ö†Ô∏è Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<p>Whereas performing automatic differentiation and gradient-descent based optimization on SBML models parameters and/or dynamical states opens many possibilities to design interventions on existing models (and potentially to transpose those in vitro), or to design new models with target properties (e.g. for synthetic circuit engineering), we found that gradient-based optimization can be hard in those models for the following reasons:</p>
<ol class="arabic simple">
<li><p>Here the rollout time is quite short at training time (T=50 secs) but the backward pass for computing the gradient is already quite involved and can be relatively long to compute (and quickly intractable when considering longer rollouts)</p></li>
<li><p>Whereas gradient-based optimization can be very efficient when backpropagating though conventional neural network layers and architectures (e.g. linear and convolutional layers), here the gradient signal can be exploding or vanishing and hard to exploit, leading very often to NaN values. This is because the backprop needs to go through all recurrent calls of the <code class="docutils literal notranslate"><span class="pre">modelstepfunc</span></code> which itself calls JAX <code class="docutils literal notranslate"><span class="pre">odeint</span></code> solver which itself must integrate a complex system of differential equations (which can take many forms). This could probably be improved by considering simpler SBML models (e.g. synthetic networks with common operations) and simpler ODE solver (e.g. simple Euler integration method)</p></li>
<li><p>Due to the non-linearity and complexity of the dynamics involved, the optimization landscape can be very hard and have a lot of local minimas. More advanced exploration methods might be necessary, in coupling with gradient-based optimization, for successfull optimization.</p></li>
</ol>
<p>Whereas we focused this tutorial on gradient-based optimization of SBML models, many other optimization methods can be envisaged in particular evolutionary algorithms which might take advantage of SBMLtoODEjax parallel execution capabilities.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="benchmark.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Benchmarking</p>
      </div>
    </a>
    <a class="right-next"
       href="../api/parse.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">sbmltoodejax.parse</span></code></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-utils">Imports and Utils</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-definition">Problem definition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-of-behavior-by-tuning-of-kinematic-parameters-c">Optimization of behavior by tuning of kinematic parameters <em>c</em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-of-behavior-by-dynamical-intervention-on-y-states">Optimization of behavior by dynamical intervention on <em>y</em> states</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">‚ö†Ô∏è Limitations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mayalen Etcheverry
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2023, Mayalen Etcheverry.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>